# アプリケーションフロー

このドキュメントでは、FableMaze の主要なユーザーフローと画面遷移について説明します。

## 全体的なユーザージャーニー

```mermaid
journey
    title FableMaze ユーザージャーニー
    section 初期設定
      ストーリー設定入力: 3: ユーザー
      ジャンル/テンプレート選択: 4: ユーザー
      AIモデル選択: 5: ユーザー
    section ストーリー生成
      初期チャプター生成: 3: ユーザー, システム
      選択肢生成: 4: システム
      Wiki自動生成: 5: システム
    section 対話
      選択肢の選択: 5: ユーザー
      次のチャプター生成: 4: システム
      Wiki参照: 5: ユーザー
    section エクスポート
      HTML生成: 3: システム
      ストーリーグラフ表示: 4: ユーザー, システム
      コンテンツのエクスポート: 5: ユーザー
```

## 主要なユーザーシナリオ

### 1. ストーリー設定と初期化

ユーザーが新しいストーリーを設定し、初期化するフロー：

```mermaid
flowchart TD
    A[アプリ起動] --> B[メイン画面表示]
    B --> C[新規ストーリー作成選択]
    C --> D{モード選択}
    D -->|即時生成モード| E[即時生成設定]
    D -->|設定協議モード| F[AIとの設定協議]
    
    E --> G[ジャンル選択]
    F --> H[対話的設定構築]
    H --> G
    
    G --> I[テンプレート選択]
    I --> J[AIモデル設定]
    J --> K[生成パラメータ設定]
    K --> L[ストーリー初期化]
    
    L --> M{生成成功?}
    M -->|はい| N[ストーリービューに遷移]
    M -->|いいえ| O[エラーメッセージ表示]
    O --> K
    
    style A fill:#bbdefb,stroke:#1976d2
    style O fill:#ffcdd2,stroke:#c62828
    style N fill:#c8e6c9,stroke:#2e7d32
```

### 2. ストーリー生成と対話

ユーザーがストーリーと対話するフロー：

```mermaid
flowchart TD
    A[ストーリービュー] --> B[初期チャプター表示]
    B --> C[選択肢表示]
    C --> D{ユーザー操作}
    
    D -->|選択肢選択| E[次のチャプターリクエスト]
    D -->|Wiki参照| F[Wikiページ表示]
    D -->|設定変更| G[AIパラメータ調整]
    
    E --> H[AIによるチャプター生成]
    H --> I{生成成功?}
    I -->|はい| J[新チャプター表示]
    I -->|いいえ| K[再試行オプション表示]
    
    F --> L[Wiki情報表示]
    L --> M[ストーリーに戻る]
    
    G --> N[設定パネル表示]
    N --> O[設定変更適用]
    O --> B
    
    J --> C
    K --> E
    M --> B
    
    style B fill:#bbdefb,stroke:#1976d2
    style H fill:#fff9c4,stroke:#fbc02d
    style K fill:#ffcdd2,stroke:#c62828
    style J fill:#c8e6c9,stroke:#2e7d32
```

### 3. ストーリーグラフの管理

ストーリーの分岐構造を管理するフロー：

```mermaid
flowchart TD
    A[グラフビュー選択] --> B[ストーリーグラフ表示]
    B --> C{ユーザー操作}
    
    C -->|ノード追加| D[新ノード作成]
    C -->|ノード編集| E[ノード内容編集]
    C -->|エッジ追加| F[選択肢追加]
    C -->|エッジ削除| G[選択肢削除]
    
    D --> H[AIによるコンテンツ生成]
    H --> I[ノードをグラフに追加]
    
    E --> J[ノード編集UI表示]
    J --> K[ノード内容更新]
    
    F --> L[選択肢テキスト入力]
    L --> M[ノード間エッジ作成]
    
    G --> N[エッジ削除確認]
    N --> O[グラフ構造更新]
    
    I --> P[グラフ表示更新]
    K --> P
    M --> P
    O --> P
    
    P --> Q[グラフの整合性検証]
    
    style B fill:#bbdefb,stroke:#1976d2
    style H fill:#fff9c4,stroke:#fbc02d
    style Q fill:#c8e6c9,stroke:#2e7d32
```

### 4. Wiki統合と管理

Wikiの管理と統合を行うフロー：

```mermaid
flowchart TD
    A[Wiki管理タブ選択] --> B[Wiki概要表示]
    B --> C{ユーザー操作}
    
    C -->|エンティティ抽出実行| D[AIによるエンティティ抽出]
    C -->|手動エンティティ追加| E[新エンティティ作成]
    C -->|エンティティ編集| F[エンティティ編集UI]
    C -->|関係追加| G[エンティティ関係定義]
    
    D --> H[抽出エンティティ表示]
    H --> I[エンティティ確認]
    I --> J[Wikiページ自動生成]
    
    E --> K[エンティティ情報入力]
    K --> L[Wikiページ作成]
    
    F --> M[エンティティ情報更新]
    M --> N[Wikiページ更新]
    
    G --> O[関係タイプ選択]
    O --> P[関係の説明入力]
    P --> Q[関係データ保存]
    
    J --> R[Wiki更新]
    L --> R
    N --> R
    Q --> R
    
    R --> S[ストーリー・Wiki整合性検証]
    
    style B fill:#bbdefb,stroke:#1976d2
    style D fill:#fff9c4,stroke:#fbc02d
    style S fill:#c8e6c9,stroke:#2e7d32
```

### 5. HTMLエクスポートとプレビュー

ストーリーをHTMLにエクスポートするフロー：

```mermaid
flowchart TD
    A[エクスポートタブ選択] --> B[エクスポート設定表示]
    B --> C[出力形式選択]
    C --> D[テンプレート選択]
    D --> E[カスタマイズオプション設定]
    E --> F[エクスポート実行]
    
    F --> G{エクスポート成功?}
    G -->|はい| H[出力ディレクトリの表示]
    G -->|いいえ| I[エラーメッセージ表示]
    
    H --> J[プレビュー表示]
    J --> K{ユーザー操作}
    
    K -->|編集| L[カスタムCSSの編集]
    K -->|承認| M[エクスポート完了]
    
    L --> N[プレビュー更新]
    N --> K
    
    I --> O[エクスポート設定の修正]
    O --> F
    
    style B fill:#bbdefb,stroke:#1976d2
    style F fill:#fff9c4,stroke:#fbc02d
    style I fill:#ffcdd2,stroke:#c62828
    style M fill:#c8e6c9,stroke:#2e7d32
```

## 画面遷移図

アプリケーションの主要な画面とその遷移：

```mermaid
stateDiagram-v2
    [*] --> 起動画面
    起動画面 --> メイン画面
    
    state メイン画面 {
        [*] --> ホームタブ
        
        state ホームタブ {
            新規ストーリー作成
            既存ストーリー一覧
            最近のストーリー
        }
        
        state ストーリータブ {
            ストーリービュー
            選択肢選択
            設定パネル
        }
        
        state グラフタブ {
            グラフビュー
            ノード編集
            エッジ管理
        }
        
        state Wikiタブ {
            Wiki概要
            エンティティ管理
            関係管理
        }
        
        state エクスポートタブ {
            エクスポート設定
            プレビュー
            出力管理
        }
        
        ホームタブ --> ストーリータブ: 新規作成/既存選択
        ストーリータブ --> グラフタブ: グラフ表示
        ストーリータブ --> Wikiタブ: Wiki参照
        ストーリータブ --> エクスポートタブ: エクスポート
        
        グラフタブ --> ストーリータブ: ノード表示
        Wikiタブ --> ストーリータブ: ストーリーに戻る
        エクスポートタブ --> ストーリータブ: ストーリーに戻る
    }
    
    メイン画面 --> ストーリー設定画面: 新規作成
    ストーリー設定画面 --> メイン画面: 設定完了
    
    メイン画面 --> 設定協議画面: 設定協議モード
    設定協議画面 --> ストーリー設定画面: 協議完了
    
    メイン画面 --> HTML出力表示: エクスポート完了
    HTML出力表示 --> メイン画面: 閲覧終了
```

## 主要画面の目的

### 1. ホーム画面

- **目的**: アプリケーションのエントリーポイント
- **機能**:
  - 新規ストーリー作成の開始
  - 既存ストーリーの一覧表示と選択
  - 最近のストーリーへの素早いアクセス
  - アプリケーション設定へのアクセス

### 2. ストーリー設定画面

- **目的**: 新規ストーリーの設定
- **機能**:
  - ジャンル選択
  - テンプレート選択
  - AIモデル設定
  - 生成パラメータ設定

### 3. 設定協議画面

- **目的**: AIとの対話による設定構築
- **機能**:
  - AIとの対話インターフェース
  - 設定サマリーの表示
  - 設定の調整と確定
  - キャラクターや世界観の協創

### 4. ストーリービュー

- **目的**: ストーリー閲覧と対話
- **機能**:
  - 現在のチャプター表示
  - 選択肢の提示と選択
  - Wiki参照リンク
  - 設定調整オプション

### 5. グラフビュー

- **目的**: ストーリー構造の可視化と編集
- **機能**:
  - 全体のグラフ表示
  - ノードの追加・編集・削除
  - エッジ（選択肢）の管理
  - 到達可能性分析

### 6. Wiki管理画面

- **目的**: 世界観の一貫性管理
- **機能**:
  - エンティティの一覧表示
  - 新規エンティティの作成
  - エンティティ間の関係定義
  - 自動抽出機能

### 7. エクスポート画面

- **目的**: ストーリーのエクスポートと公開
- **機能**:
  - 出力形式の選択
  - テンプレートのカスタマイズ
  - プレビュー表示
  - 出力先の設定

## 重要な意思決定ポイント

アプリケーション内の主要な意思決定ポイントとその選択肢：

```mermaid
flowchart TD
    A[意思決定ポイント] --> B{ストーリー生成モード}
    B -->|即時生成モード| B1[簡易設定・迅速生成]
    B -->|設定協議モード| B2[詳細設定・AIとの協議]
    
    A --> C{ジャンル選択}
    C -->|ファンタジー| C1[中世風世界観]
    C -->|SF| C2[未来技術世界観]
    C -->|ミステリー| C3[謎解き重視]
    C -->|その他| C4[カスタム設定]
    
    A --> D{AIモデル選択}
    D -->|GPT-4| D1[高品質・高コスト]
    D -->|Llama3| D2[ローカル実行・低コスト]
    D -->|Mixtral| D3[バランス型]
    
    A --> E{Wiki自動生成設定}
    E -->|高自動化| E1[多数のエンティティを自動抽出]
    E -->|低自動化| E2[主要エンティティのみ抽出]
    E -->|手動管理| E3[手動でのエンティティ追加]
    
    A --> F{エクスポート形式}
    F -->|静的HTML| F1[ウェブサイトとして出力]
    F -->|インタラクティブHTML| F2[JavaScript機能付き]
    F -->|ePub| F3[電子書籍形式]
    F -->|JSON| F4[データ形式で出力]
    
    style A fill:#bbdefb,stroke:#1976d2
    style B fill:#fff9c4,stroke:#fbc02d
    style C fill:#fff9c4,stroke:#fbc02d
    style D fill:#fff9c4,stroke:#fbc02d
    style E fill:#fff9c4,stroke:#fbc02d
    style F fill:#fff9c4,stroke:#fbc02d
```

## エラーケースと代替フロー

### 1. ストーリー生成エラー

AIからのレスポンスに問題がある場合の代替フロー：

```mermaid
flowchart TD
    A[ストーリー生成リクエスト] --> B{生成エラー}
    B --> C[エラー詳細を表示]
    C --> D{エラーの種類}
    
    D -->|APIエラー| E[API設定を確認するよう促す]
    D -->|形式エラー| F[プロンプトを調整するよう促す]
    D -->|タイムアウト| G[再試行または短縮版を生成するよう促す]
    D -->|コンテンツポリシー違反| H[設定の変更を促す]
    D -->|その他| I[詳細ログを表示]
    
    E --> J[API設定修正]
    F --> K[プロンプト修正]
    G --> L[パラメータ調整]
    H --> M[設定変更]
    I --> N[トラブルシューティングガイド表示]
    
    J --> O[再生成]
    K --> O
    L --> O
    M --> O
    N --> O
    
    O --> P{再生成成功?}
    P -->|はい| Q[生成成功・表示]
    P -->|いいえ| C
    
    style B fill:#ffcdd2,stroke:#c62828
    style Q fill:#c8e6c9,stroke:#2e7d32
```

